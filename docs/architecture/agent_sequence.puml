@startuml
title Seichijunrei Agent System - Sequence Diagram

actor User
participant "Root Agent" as Root
participant "ExtractionAgent" as Extract
participant "BangumiCandidatesAgent" as BangumiCand
participant "UserPresentationAgent" as UserPres
participant "Session State" as Session
participant "UserSelectionAgent" as UserSel
participant "PointsSearchAgent" as PointsSearch
participant "PointsSelectionAgent" as PointsSel
participant "RoutePlanningAgent" as RoutePlan
participant "RoutePresentationAgent" as RoutePres

== Stage 1: Bangumi Search ==
User -> Root: "I want to visit Kamakura"
Root -> Extract: Execute
Extract -> Extract: Extract bangumi_name,\nlocation, user_language
Extract -> Session: Write extraction_result
Extract --> Root: ExtractionResult

Root -> BangumiCand: Execute
BangumiCand -> BangumiCand: Search Bangumi API
BangumiCand -> BangumiCand: Format top 3-5 results
BangumiCand -> Session: Write bangumi_candidates
BangumiCand --> Root: BangumiCandidatesResult

Root -> UserPres: Execute
UserPres -> Session: Read bangumi_candidates
UserPres -> UserPres: Generate natural\nlanguage presentation
UserPres --> Root: Natural language
Root --> User: "Here are 3 anime options:\n1. Slam Dunk\n2. Tari Tari\n3. ..."

== User Selection ==
User -> Root: "I choose number 1"
Root -> UserSel: Execute
UserSel -> Session: Read bangumi_candidates
UserSel -> UserSel: Parse user selection
UserSel -> Session: Write selected_bangumi
UserSel --> Root: UserSelectionResult

== Stage 2: Route Planning ==
Root -> PointsSearch: Execute
PointsSearch -> PointsSearch: Call Anitabi API
PointsSearch -> Session: Write all_points
PointsSearch --> Root: All points

Root -> PointsSel: Execute
PointsSel -> Session: Read all_points
PointsSel -> PointsSel: LLM selects\n8-12 best points
PointsSel -> Session: Write points_selection_result
PointsSel --> Root: PointsSelectionResult

Root -> RoutePlan: Execute
RoutePlan -> RoutePlan: Call plan_route tool
RoutePlan -> Session: Write route_plan
RoutePlan --> Root: RoutePlan

Root -> RoutePres: Execute
RoutePres -> Session: Read route_plan
RoutePres -> RoutePres: Generate natural\nlanguage route
RoutePres --> Root: Natural language
Root --> User: "Start from Kamakura Station...\nTotal ~5 hours"

@enduml